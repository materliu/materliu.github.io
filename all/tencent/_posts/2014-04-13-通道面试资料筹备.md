---
layout: post
title: 2014-04-13-通道面试资料筹备.md
---

## 通道面试资料筹备

一旦QQ查找全量，这个问题再发生的话，我们面临着什么？
太尼玛恐怖了。



arieslei(雷波) 05-16 17:00:51
出问题的index.html页面是由cgi吐的，没有任何cache相关的头，就下面这些

arieslei(雷波) 05-16 17:01:09
mater说这种情况的cache是由浏览器控制的
arieslei(雷波) 05-16 17:02:31
现在相当于有2个首页，一个是静态文件index.html，一个是cgi去吐页面，现网是有大概5%的电信用户会有一定概率访问到cgi这个环境
chappellqu(屈超) 05-16 17:02:54
缓存出问题的是哪个？
arieslei(雷波) 05-16 17:03:02
cgi的那个
chappellqu(屈超) 05-16 17:04:01
所以还是用 chrome cache view 看一下
之前的经验是有时候 cgi 带了参数 chrome 会缓存另一份
chappellqu(屈超) 05-16 17:04:12
先把有问题的 cache 包拿上来
plutoxiong(熊义林) 05-16 17:04:18
是出了404之后出现的这个问题吧
arieslei(雷波) 05-16 17:04:52
不是404，是cgi前面的nginx吐的个默认页面而已
rehornchen(陈桂鸿) 05-16 17:18:14
看了缓存，这个请求
的页面内容就是
rehornchen(陈桂鸿) 05-16 17:18:39

rehornchen(陈桂鸿) 05-16 17:19:06
status code 是200，没被缓存
materliu(刘炬光) 05-16 17:19:47

materliu(刘炬光) 05-16 17:20:01
确实吐出来的就是这个页面
arieslei(雷波) 05-16 17:20:40
有问题的nginx当时就改回去了，影响不过3-5分钟，这个我可以确定

过了大概半个小时后，dily这边是通过删除webkit文件夹才ok的
arieslei(雷波) 05-16 17:21:42
上报的数据也看得出来影响的时间段,出问题就是这红框的几分钟而已

materliu(刘炬光) 05-16 17:35:32
我用这个cache替换，看到确实是被缓存住了
rehornchen(陈桂鸿) 05-16 17:35:59

materliu(刘炬光) 05-16 17:36:31

materliu(刘炬光) 05-16 17:46:39

materliu(刘炬光) 05-16 17:47:03
出错的那次多了一个
arieslei(雷波) 05-16 17:49:28
172.27.6.7 搭了个环境，可以重现，出问题以后，不管打开多少次查找页面，都不会发请求的
materliu(刘炬光) 05-16 18:02:49

materliu(刘炬光) 05-16 18:03:03
雷总给的这个测试环境也是多了个last-modified
materliu(刘炬光) 05-16 18:03:19
我想一下为啥有了这个浏览器就说啥也不发起请求了
arieslei(雷波) 05-16 18:03:32
多了能怎么样，按理这种要走304，每次要去问啊，ie就会去问304
materliu(刘炬光) 05-16 18:05:30

materliu(刘炬光) 05-16 18:05:32
先去吃饭
materliu(刘炬光) 05-16 18:05:39
回来看一下是不是说的这个问题
arieslei(雷波) 05-16 18:11:01
好象是类似的问题，没有显式指明缓存策略，chrome会有一套自己的“缓存算法”，就会导致今天的问题
http://stackoverflow.com/questions/10040670/chrome-doesnt-send-if-modified-since
arieslei(雷波) 05-16 18:37:58
就是上面这个原因，nginx这边如果默认不配置root的话，当某个请求匹配不到任何规则的时候，就会返回默认页面，这个页面是没有cache策略相关头的，所以碰到chrome会出现这个问题

如果配置了root，顶多是404，不会再本地长缓存
materliu(刘炬光) 05-16 18:43:39
确实
materliu(刘炬光) 05-16 18:44:04
说的表现跟我们的很相符
materliu(刘炬光) 05-16 18:49:24
那是不是可以理解成是chrome自以为是的做了这样一个优化
materliu(刘炬光) 05-16 18:49:38
而现实环境中这个条件其实很难命中
materliu(刘炬光) 05-16 18:50:34
要没有 expires max-age 同时有 last-modified header 并且last-modified的值要远早于last accessed
arieslei(雷波) 05-16 18:50:49
现实中很容易出现，用nginx做反向代理的一大堆，配置少了个符号就有可能不命中，就要悲剧
arieslei(雷波) 05-16 18:54:13
google果然尼玛以人为本，鬼知道代码里面还有哪些“人性化”的其他东西
materliu(刘炬光) 05-16 18:55:48
应该是工程师自由发挥的空间比较大







镜像字符 在unicode里边的表示
aniszhang(张龙飞) 05-28 15:12:50
1654363488
aniszhang(张龙飞) 05-28 15:12:54
mater看看
aniszhang(张龙飞) 05-28 15:12:59
cgi没有返回这个88的数字
aniszhang(张龙飞) 05-28 15:13:02
为什么会显示
aniszhang(张龙飞) 05-28 15:13:21
号码被前台倒序了
materliu(刘炬光) 05-28 15:26:39

materliu(刘炬光) 05-28 15:26:42
这是一个神奇的号码
materliu(刘炬光) 05-28 15:26:43
在
materliu(刘炬光) 05-28 15:26:50
QQ里边也被逆序了
aniszhang(张龙飞) 05-28 15:36:02
我擦
materliu(刘炬光) 05-28 15:48:56
看了一下
materliu(刘炬光) 05-28 15:49:20
大概明白是怎么意思了
materliu(刘炬光) 05-28 15:50:39
但还没有完全想明白
materliu(刘炬光) 05-28 16:13:06
想问一下
materliu(刘炬光) 05-28 16:13:07

materliu(刘炬光) 05-28 16:13:25
QQ自己的面板和快速搜索面板也是拉的两套不同的数据库吗？
materliu(刘炬光) 05-28 16:13:29
这里有人知道吗？
materliu(刘炬光) 05-28 16:14:20
之所以会倒序显示，是因为用户在昵称里边注入了镜像字符
materliu(刘炬光) 05-28 16:14:29
但他是怎么注入的，我还没试出来
jayyu(俞晓炀) 05-28 16:14:57
这个找下nicolle看下呗
nicolleye 加入了本次会话。
materliu(刘炬光) 05-28 16:16:07
nicolle 有个问题请求你一下
materliu(刘炬光) 05-28 16:16:12

materliu(刘炬光) 05-28 16:16:20
QQ自己的面板和快速搜索面板也是拉的两套不同的数据库吗？
nicolleye(叶茂) 05-28 16:24:25
这个逻辑我不清楚。是客户端实现的
jayyu(俞晓炀) 05-28 16:25:24
我找下客户端searchbar的产品
hammerwu 加入了本次会话。
jayyu(俞晓炀) 05-28 16:26:07
hammer，searchbar有个诡异的bug
hammerwu(吴宏达) 05-28 16:26:20
什么
jayyu(俞晓炀) 05-28 16:26:22

jayyu(俞晓炀) 05-28 16:26:38
在searchbar搜到的这个号码，显示的是倒序的
hammerwu(吴宏达) 05-28 16:28:01
我提给测试看下
materliu(刘炬光) 05-28 16:28:10
已经知道什么原因了
hammerwu(吴宏达) 05-28 16:28:16
其他帐号好像没这个问题
hammerwu(吴宏达) 05-28 16:28:23
只是这个帐号
materliu(刘炬光) 05-28 16:28:30
只是想知道这里的快速搜索 和 详细资料页 拉取的不是同一个数据库吗？
hammerwu(吴宏达) 05-28 16:29:43
应该是的，要问下jiajuan
materliu(刘炬光) 05-28 16:31:12
那就更奇怪了， 如果是同一个数据库； 详细资料卡拉的昵称是 1654363488； searchbar这里拉到的是一个镜像字符
hammerwu(吴宏达) 05-28 16:34:49
问了下，搜索这里没有做过相关的逻辑，怀疑是这个帐号本身的什么属性导致的
hammerwu(吴宏达) 05-28 16:35:38

hammerwu(吴宏达) 05-28 16:35:45
新版的查找搜出来也是倒着的
materliu(刘炬光) 05-28 16:35:47
我们也没有做特殊逻辑
materliu(刘炬光) 05-28 16:35:53
我是新版查找的前端开发
hammerwu(吴宏达) 05-28 16:36:10

hammerwu(吴宏达) 05-28 16:36:16
老的查找是正的
materliu(刘炬光) 05-28 16:36:29
搜索bar 这里也是web页面吗？
hammerwu(吴宏达) 05-28 16:36:34
不是
hammerwu(吴宏达) 05-28 16:36:37
客户端的
materliu(刘炬光) 05-28 16:38:20
那难道是他们都有做特殊处理吗？
hammerwu(吴宏达) 05-28 16:39:05
没有啊，客户端这边没有做特殊逻辑，其他帐号也是正常的啊
materliu(刘炬光) 05-28 16:40:57
没做特殊逻辑一般的账号不会有问题，但是遇到昵称里边含镜像字符的就会出问题
hammerwu(吴宏达) 05-28 16:46:19
什么叫镜像字符
materliu(刘炬光) 05-28 16:47:19
跟在镜像字符后边的东西都按照从右到左的顺序展示
materliu(刘炬光) 05-28 16:47:28
以前常是用来网络攻击的
materliu(刘炬光) 05-28 16:47:46
document[U+202E]fdp.exe visually looks like documentexe.pdf
比如说这种
materliu(刘炬光) 05-28 16:48:00
文件本来是 documentfdp.exe 可执行病毒
materliu(刘炬光) 05-28 16:48:17
但因为加了镜像字符，用户看上去就成了 documentexe.pdf 一个文本文件
hammerwu(吴宏达) 05-28 16:53:41
那这里的问题是？要对这种特殊的情况做处理？
materliu(刘炬光) 05-28 16:55:12
我很奇怪，为什么客户端详细资料页 和 老版查找没有问题
materliu(刘炬光) 05-28 17:15:13
能从后台看看他是怎么注入的吗？
materliu(刘炬光) 05-28 17:15:19
我实在是试不出来
hammerwu(吴宏达) 05-28 17:17:11
后台应该找谁
materliu(刘炬光) 05-28 17:23:38
@nicolleye 那边能看看这个人的昵称在后台存的是啥吗？
materliu(刘炬光) 05-28 17:37:16
manfred那边看好像是ep
materliu(刘炬光) 05-28 17:37:20
但不是一般的ep
manfredhu(胡新帮) 05-28 17:47:18
这个是昵称的16进制编码：e280 aee2 80ae e280 aee2 80ae
materliu(刘炬光) 05-28 17:47:45
能想到他是怎么注入进去的吗？
materliu(刘炬光) 05-28 17:49:09
我打出来unicode编码是 8238 8238
materliu(刘炬光) 05-28 17:49:11
8238
materliu(刘炬光) 05-28 17:49:13
8238
materliu(刘炬光) 05-28 17:49:20

materliu(刘炬光) 05-28 17:49:22
前台拿到的
materliu(刘炬光) 05-28 17:52:58
我找到解决方案了
materliu(刘炬光) 05-28 17:53:01
但是担心会误伤
materliu(刘炬光) 05-28 17:53:42
镜像字符的unicode值在前台打印出来就是 8238
materliu(刘炬光) 05-28 17:53:48
可以屏蔽掉
materliu(刘炬光) 05-28 17:55:32
manfred 你用 utf-16打印出来看看跟我的是不是一样的
materliu(刘炬光) 05-28 17:55:57
这个是昵称的16进制编码：e280 aee2 80ae e280 aee2 80ae
这个应该是用的utf-8 编码吧
manfredhu(胡新帮) 05-28 18:36:12
对utf-8的。
materliu(刘炬光) 05-28 19:04:19
这种我们有必要处理吗？觉得太小众了

* 手Q4.7开始 使用了QQ浏览器提供的webView SDK， 这就会导致手Q4.7使用的webview中webkit内核的版本可能跟当前用户所使用的系统的webview的webkit的版本不同

最蛋疼的是这里还有一个容易出问题的逻辑：

materliu(刘炬光) 03-26 16:58:52

清除应用数据 第一次进去使用的系统webview ？

materliu(刘炬光) 03-26 16:59:02

之后进入就使用的 x5 webview？

cokesu(苏可) 03-26 16:59:41

@materliu(刘炬光) ，是这样的逻辑，因为DEX OPT比较耗时，容易导致ＡＮＲ，所以第一次进会切为系统WebView


### 发现的团队中其他成员存在的问题：
1. cgi数据拿到之后不进行预处理， 没有model的意识， 直接渲染至模板。

2. 不知统一处理， 用到一处打一枪， 比如说icon的处理， <i class='icon-lighting'></i>

css会写：

```
.icon-lighting {
    ------
    display: inline-block;
}
```

每个icon都要这样写一次

而不是有一个统一的规划：

```
[class^="icon-"], [class*="icon-"] {
    display: inline-block;
}
```