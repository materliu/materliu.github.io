---
layout: post
title: 2014-04-09-手Qzip包导致的缓存问题.md
---

## 手Qzip包导致的缓存问题

手Q为其上的所有webview业务提供了一个zip包能力， 即可以把你所有的前台资源打包到一个zip包中， 手Q把这个zip包load进本地，然后用户打开相关的webview业务的时候， 手Q直接返回zip包中的页面资源， 避免了网络请求的巨大消耗。这是大背景。

但是问题来了， 很多人反馈具体业务中， 新发zip包后首页不更新。

解决思路： 首先想到的就是首页被浏览器缓存， 为什么首页会被浏览器缓存， 这就需要我们通过实验验证了。

1. 将手机的网络连接到自己的pc环境上， 不知道如何实现这一步的同学可以参考 手Q群查找README文件中的环境搭建。

2. 在pc上起一个server， 提供群查找相关的页面资源访问

3. 在手机上删除zip包， 直接访问群查找， pc返回的index.html http header如下：

<pre>
HTTP/1.1 200 OK
accept-ranges: bytes
etag: "10691-1396358692000"
date: Wed, 09 Apr 2014 02:40:42 GMT
cache-control: public, max-age=0
last-modified: Tue, 01 Apr 2014 13:24:52 GMT
content-type: text/html; charset=UTF-8
content-length: 10917
connection: keep-alive
</pre>

访问

4. 退出当前webview 重新进入

请求依然发起, 没有被浏览器长cache

5. 在3中返回的内容的基础上去掉 cache-control  header 和 last-modified  header，此时返回的header 如下：

<pre>
HTTP/1.1 200 OK
accept-ranges: bytes
etag: "10691-1396358692000"
date: Wed, 09 Apr 2014 02:40:42 GMT
content-type: text/html; charset=UTF-8
content-length: 10922
connection: keep-alive
</pre>

访问

6. 退出当前webview 重新进入

请求依然发起， 没有被浏览器长cache

7. 在5中返回的内容的基础上去掉 data ， etag header，  此时返回的header 如下：

<pre>
HTTP/1.1 200 OK
accept-ranges: bytes
content-type: text/html; charset=UTF-8
content-length: 10922
connection: keep-alive
</pre>

访问

8. 退出当前webview 重新进入

请求依然发起， 没有被浏览器长cache

9. 在7中返回内容的基础上去掉 accept-ranges: bytes charset=UTF-8 connection: keep-alive ,Content-type 此时返回的header 如下：

<pre>
HTTP/1.1 200 OK
content-length: 10922
</pre>

content-length 是一定要保留的， 不然浏览器不知道如何处理当前页面，因为不知道什么时候内容返回结束了

访问

10. 退出当前webview 重新进入

请求依然能正常发起

基本可以得出结论： http header 的缺失并不会导致页面被常cache住。

这接下来就没办法再试了， 基本可以推定出就是 客户端的bug了 ！

然后开始定位客户端bug： 移交给客户端同学定位， 后续在这里同步！

